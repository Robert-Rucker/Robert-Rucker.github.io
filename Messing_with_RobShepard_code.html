<!DOCTYPE html>
<!-- notes 
Rob Shepard, GIS Specialist at University of Iowa Libraries
Special thanks to CDRH's Jessica Dussault for providing some Leaflet coding framework (this is based on Buffalo Bill project)
Thanks to University of Iowa's Digital Scholarship and Publishing Studio for hosting the content

NEAT

-->
<html>
  <head>
    <title>Nashville, 1860</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- INCLUDES -->
      <!-- include leaflet / slider css, js local files -->
      <script src="https://cdn.jsdelivr.net/leaflet/1.0.0-rc.3/leaflet-src.js"></script>
      <link rel="stylesheet" href="public/leaflet-1/leaflet.css" />
	  <!--OLD LINK IS HERE - <link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet/1.0.0-rc.3/leaflet.css" /> -->
      <script src="public/leafletSlider-1.0.2/leaflet.SliderControl.min.js"></script>
      <!-- include a pretty little stamenizer -->
      <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
      <!-- include fuse first, then the leaflet plugins that use fuse searching -->
      <script src="public/fuse-1.2.1/fuse.min.js"></script>
      <script src="public/leafletFuseSearch-noVersion/leafletfuse.js"></script>
      <link rel="stylesheet" href="public/leafletFuseSearch-noVersion/leafletfuse.css" type="text/css"/>
      <!-- jquery scripts and css -->
      <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
      <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
      <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" type="text/css">
      <!-- Include this library for mobile touch support (not tested) -->
      <script src="public/jqueryUiTouchPunch-0.2.2/jquery.ui.touch-punch.min.js"></script>
	    <!-- Load Esri Leaflet from CDN -->
  <script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.2/esri-leaflet.js"></script>
      <!-- include json data points -->
      <script src="nashpeople.js"></script>
	  <script src="poc.js"></script>
	  <script src="neliteclass.js"></script>
	  <script src="nmerchclass.js"></script>
	  <script src="nworkclass.js"></script>
	  <script src="https://Robert-Rucker.github.io/nelderlyclass.js"></script>
	  <script src="https://Robert-Rucker.github.io/nelderlyclass.js "></script>
	  <script src="https://Robert-Rucker.github.io/nelderlyclass.js "></script>
	  <link rel="stylesheet" type="text/css" href="css/style.css">
	  <link rel="stylesheet" type="text/css" href="css/navwrap.css">
  </head>


  <body>

 
    <!-- provide the map with a div to live inside -->
    <div id="map" style="width: 100%; height: 650px"></div>
<!-- <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
-->
    <script>
      // set up with openstreetmaps
	  
	  	  var myIcon = L.icon({
    iconUrl: 'my-icon.png',
    iconRetinaUrl: 'my-icon@2x.png',
    iconSize: [1, 1],
    iconAnchor: [1, 1],
    popupAnchor: [-1, -1]
});
	  
//THIS IS THE OLD CODE, SETS JUST THE BASE MAP WITHOUT OTHER BASE LAYERS	 
//      var map = L.map('map').setView(new L.LatLng(41.259944, -95.937057), 15);
	  
      // grabbing custom base map
// L.esri.tiledMapLayer({
//    url: "https://gis.lib.uiowa.edu/gislib1/rest/services/Rob/omabase/MapServer"
//  }).addTo(map);
//AND YOU CAN UNCOMMENT DOWN TO HERE TO REACTIVATE, BUT WHY -> Robert Rucker: Because you gave me a different assignment and I can read your code easily.  That's a lie I just rewrote some of your code for lab 8.

	 var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="http://mapbox.com">Mapbox</a>'; 
	  
//here I use an esri tiled WMS layer, a tiled layer out on mapbox, and a GeoServer tiled map service. This is really for my own reference... PS the commas and "names = " stuff replaces variables. You call up all the layers in one spot
	  
	 var esrilayer =  L.esri.tiledMapLayer({url: "https://gis.lib.uiowa.edu/gislib1/rest/services/Rob/nashbase2/MapServer"}),
	 grayscale = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicmNzaGVwYXJkIiwiYSI6IjYwYjI0NzdmNDQwM2YzNTc1ODI2NWZhNTU1ZTVmNjY4In0.ct_UnOxwtV_WIGwzyG0Rxw', {id: 'mapbox.light', attribution: mbAttr}),
	 opengeo = L.tileLayer.wms('https://compass.lib.uiowa.edu/geoserver/test/wms', {layers: 'test:omabase', format: 'image/png', transparent: false, version: '1.1.1', attribution: "myattribution"});
	 
      var map = L.map('map', {
	  center: [36.162850, -86.779539],
	  zoom: 16,
	  layers: [esrilayer] 
	  });

  
      // original open street maps tiles, remove above few lines and uncomment these
      /*L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);*/

      // onEachFeature generate a popup for each location
      // those params are coming automatically from the geoJson method
      var onEachFeature = function(feature, layer) {
        if (feature.properties) {
          var prop = feature.properties;
          // make a cool little html popup with properties
            var popup = '<h3>'+prop['FNAME']+' '+prop['LNAME']+'</h3>'+'<strong>Race/Gender: </strong>'+prop['RACE']+' '+prop['GENDER']+'<br><strong>Occupation: </strong>'+prop['OCCUPATION']+'<br><strong>Age: </strong>'+prop['AGE']+'<br><strong>Family Estate: $</strong>'+prop['PERSREAL']+'<br> <strong>Fam. Real Estate: $</strong>'+prop['FAMREAL']+'<br><strong>Address: </strong>'+prop['ADDRESS']+'<br><br><i>details from Census Bureau and city directories</i>';
            // add known info about event to the description
          
          // you must create a layer property on each feature or else
          // the search results won't know where the item is on the map / layer
          feature.layer = layer;
          layer.bindPopup(popup, {maxWidth: "auto"});
        }
      }; // end onEachFeature

      // used by the generic "all locations" layer
      var blueCircleMarkers = {
        radius: 4,
        fillColor: "#00AEEF",
        color: "#3978BF",
        weight: 1,
        opacity: 0.8,
        fillOpacity: 0.5
      };

      // used by the timesliding layer
      var orangeCircleMarkers = {
        radius: 5,
        fillColor: "#ED1C24",
        color: "#ED1C24",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.7
      };

      // used by the searching layer - made them yellow instead of green YOU'RE NOT THE BOSS OF ME!
      var greenCircleMarkers = {
        radius: 5,
        fillColor: "#ffff00",
        color: "#286933",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.7
      };
	  
	  var selectedmarker = {
	  radius: 6,
        fillColor: "#f7971c",
        color: "#f7971c",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      };

      // generate a layer of markers for all the locations
      L.geoJson(nashpeople, {
        // add popups
        onEachFeature: onEachFeature,
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, blueCircleMarkers);
        }
      }).addTo(map);

       //now make a timeline layer that the slider can manipulate - REMOVED
      var timelineLayer = L.geoJson(nashpeople, {
        onEachFeature: onEachFeature,
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, orangeCircleMarkers);
        }
      });

      // make a search layer
      // now make a timeline layer that the slider can manipulate
      var searchLayer = L.geoJson(nashpeople, {
        onEachFeature: onEachFeature,
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, greenCircleMarkers);
        }
      });
      // searchLayer.addTo(map);


      // create the slider   - REMOVED
      var sliderControl = L.control.sliderControl({
          position: "topright",
          layer: timelineLayer,
          range: true // gives it a bottom and a top slider
      });

 //     map.addControl(sliderControl);
  //    sliderControl.startSlider(); // initialize

      // Add fuse search control
      var searchOptions = {
        position: 'topleft',
        title: 'Search',
        placeholder: 'Example: John Smith',
        maxResultLength: 10,
        caseSensitive: false,
        showInvisibleFeatures: true,
        layerToToggle: searchLayer,
        threshold: 0.5, // default is .5, will match imperfect results
        showResultFct: function(feature, container) {
          props = feature.properties;
          var name = L.DomUtil.create('b', null, container);
          name.innerHTML = props.LNAME;

          container.appendChild(L.DomUtil.create('br', null, container));

          var cat = props.LNAME ? props.FNAME : props.OCCUPATION,
              info = cat;
          container.appendChild(document.createTextNode(info));
        }
      };
      var searchControl = L.control.fuseSearch(searchOptions);
      map.addControl(searchControl);
      searchControl.indexFeatures(nashpeople, ['LNAME']);

      displayFeatures(nashpeople, searchLayer);

      function displayFeatures(features, layer) {
        var popup = L.DomUtil.create('div', 'tiny-popup', map.getContainer());
        for (var id in features) {
          var feat = features[id];
          var cat = feat.properties.categorie;
          var site = L.geoJson(feat, {
            pointToLayer: function(feature, latLng) {
              var marker = L.marker(latLng, {
			    icon: myIcon,
                keyboard: false,
                riseOnHover: true
              });
              if (! L.touch) {
                marker.on('mouseover', function(position) {
                  // TODO can put text in here when hovering search
                  // popup.innerHTML = 'Testing';
                  // L.DomUtil.setPosition(popup, pos);
                  // L.DomUtil.addClass(popup, 'visible');
                }).on('mouseout', function(position) {
                  L.DomUtil.removeClass(popup, 'visible');
                });
              }
              return marker;
            },
            onEachFeature: onEachFeature
          });
          if (layer !== undefined) {
              layer.addLayer(site);
          }
        }
        return layer;
      };
	  //adds a layer for some other geojson, just change out "nashpeople" with another file
	  
//	    var grayscale = L.tileLayer(mbUrl, {id: 'mapbox.mapbox-terrain-v2', attribution: mbAttr});

	 var poc = new L.geoJson(pocGeoJson, {
	  onEachFeature: onEachFeature,
pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, greenCircleMarkers);
    }});

	 var neliteclass = new L.geoJson(neliteclass, {
	  onEachFeature: onEachFeature,
pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, greenCircleMarkers);
    }});
	
	var nmerchclass = new L.geoJson(nmerchclass, {
	  onEachFeature: onEachFeature,
pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, greenCircleMarkers);
    }});
	
	var nworkclass = new L.geoJson(nworkclass, {
	  onEachFeature: onEachFeature,
pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, greenCircleMarkers);
    }});
	  
//	  		var baseLayers = {
//			"Dark": grayscale
//		};
	  
	  		var overlays = {
			"People of Color": poc,
			"Wealthy Elite": neliteclass,
			"Merchant Class": nmerchclass,
			"Working Class": nworkclass,
			"Elderly People": nelderlyclass,
			"Women": nwomen,
			"Men": nmen
	  };
	  
			var baseMaps = {
			"Historic": esrilayer,
			"Modern Grayscale": grayscale,
			"opengeo": opengeo
			};
	  
	  L.control.layers(overlays, baseMaps, {collapsed:false}).addTo(map);

    </script>
	
  </body>
</html>
